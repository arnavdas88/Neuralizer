<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Neuralizer</title>


    <script type='text/javascript' src='http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG'></script>
    <!--jQuery-->
    <script src="js/jquery-3.0.0.min.js"></script>
    <!-- bootstrap -->
    <link href="css/bootstrap-glyphicons.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap select -->
    <link rel="stylesheet" href="css/bootstrap-select.css"> <!-- js is at the end -->
    <!-- style -->
    <link href="https://fonts.googleapis.com/css?family=Lato:100,700" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <!-- neuralizer scripts -->
    <script src="js/utils.js"></script>
    <script src="js/objects.js"></script>
    <script src="js/nn.js"></script>
    <script src="js/transforms.js"></script>
    <script src="js/shapes.js"></script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      displayAlign: "left",
      displayIndent: "2em",
      SVG: { scale: 120 }
    });
    </script>

    <script type="text/javascript">

        var canvas;
        var ctx;
        var button;
        var is_mouse_down;
        var pointer_is_on_shape_border;
        var need_draw;
        var init_arrow;
        var current_arrow;
        var arrows;
        var shapes_and_arrows;
        var degree;
        var xm = 0, ym = 0;
        var primary_selected_shape = -1;
        var shapes = [];
        var selected_shapes = [];
        var current_color_idx = 0;
        var selection_box = new Rectangle(0, 0, 0, 0, 2, 0, 2, "", new Color(0, 0, 0, 0), new Color(255, 255, 255, 1), true);
        var mathjax_element_idx = 1;
        var clipboard = [];
        var current_timestep = 0;
        var stored_states = [];

        function download_as_file(filename, text) {
            // Download the text as a file to the user's machine
            var link = document.createElement("a");
            link.setAttribute("target","_blank");
            if(Blob !== undefined) {
                var blob = new Blob([text], {type: "text/plain"});
                link.setAttribute("href", URL.createObjectURL(blob));
            } else {
                link.setAttribute("href","data:text/plain," + encodeURIComponent(text));
            }
            link.setAttribute("download",filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function save_current_state_to_file() {
            // download the current state to the user's machine
            download_as_file("topology.txt", JSON.stringify(stored_states[current_timestep-1]));
        }

        function save_state() {
            // save the state of the designer in the buffer
            var current_state = {"shapes": JSON.stringify(shapes, function(k,v) {
                if (v == selection_box) {
                    return undefined;
                }
                return v;
            }), "arrows": JSON.stringify(arrows)};

            if (current_timestep <= 1 || current_state["shapes"] != stored_states[current_timestep-1]["shapes"]) {
                stored_states[current_timestep] = current_state;
                current_timestep += 1;
            }
        }

        function load_state(state) {
            // load the given state to the designer
            shapes = JSON.parse(state["shapes"]);
            for (var s = shapes.length-1; s >= 0; s--) {
                if (shapes[s] == null || shapes[s] == undefined) {
                    shapes.splice(s,1);
                    continue;
                }
                if (shapes[s].type == "Rectangle") {
                    shapes[s] = new Rectangle(shapes[s]);
                } else if (shapes[s].type == "Triangle") {
                    shapes[s] = new Triangle(shapes[s]);
                } else if (shapes[s].type == "Circle") {
                    shapes[s] = new Circle(shapes[s]);
                }
            }
            shapes.push(selection_box);
        }

        function undo() {
            // undo changes
            if (current_timestep > 1) {
                current_timestep -= 1;
                load_state(stored_states[current_timestep-1]);
                return true;
            }
            return false;
        }


        function redo() {
            // redo changes
            if (current_timestep < stored_states.length) {
                load_state(stored_states[current_timestep]);
                current_timestep += 1;
                return true;
            }
            return false;
        }

        function draw_all_arrows(ctx) {
            // calls the draw function for all the currently available arrows
            for (var a = 0; a < arrows.length; a++) {
                arrows[a].draw(ctx);
            }
        }

        function draw_all_shapes(ctx) {
            // calls the draw function for all the currently available shapes
            for (var s = 0; s < shapes.length; s++) {
                shapes[s].draw(ctx);
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            draw_all_shapes(ctx);
            if (pointer_is_on_shape_border > -1) {
                ctx.beginPath();
                ctx.arc(xm, ym, 5, 0, 2 * Math.PI, false);
                ctx.fillStyle = shapes_and_arrows[pointer_is_on_shape_border].border_color.to_string();
                ctx.fill();
            }
            draw_all_arrows(ctx);

            current_arrow.draw(ctx);
        }

        function toggle_params(select) {
            // open the parameters section for the selected layer type only
            select = $("#layerType");

            var types = {
                "DataPlaceholder": "#dataParams",
                "Pooling": "#poolingParams",
                "Convolution": "#convolutionParams",
                "Activation": "#activationParams",
                "Regularization": "#regularizationParams",
                "ElementWise": "#elementWiseParams",
                "InnerProduct": "#innerProductParams",
                "SpecialBlock": "#specialBlockParams"
            };

            // close all other than the given type
            for (var key in types) {
                if ($(select).val() == key) {
                    $(types[key]).show("fast");
                } else {
                    $(types[key]).hide("fast");
                }
            }

        }


        function highlight_selected_shapes() {
            var s;
            for (s = 0; s < shapes.length; s++) {
                if (shapes[s] == selection_box) continue;

                if (selected_shapes.length > s && selected_shapes[s] == true) {
                    shapes[s].highlight();
                }
            }
            draw();
        }

        function get_short_name(layer_type) {
            // get a short default name for a layer
            var types = {
                "DataPlaceholder": "data",
                "Pooling": "pool",
                "Convolution": "conv",
                "Activation": "activation",
                "Regularization": "regularization",
                "ElementWise": "+",
                "InnerProduct": "inner"
            };
            if (types[layer_type] != undefined) {
                return types[layer_type];
            }
            return "";
        }


        function update_shape() {
            if (primary_selected_shape > -1 && shapes.length > primary_selected_shape) {
                shapes[primary_selected_shape].update_text($("#layerName").val());
            }
            draw();
        }

        function toggle_add_or_remove_button() {
            var add_layer_icon = $("#addLayerIcon");
            if ($(add_layer_icon).attr('data-original-title') == "Add") {
                $(add_layer_icon).attr('data-original-title', "Remove");
            } else {
                $(add_layer_icon).attr('data-original-title', "Add");
            }
            $(add_layer_icon).toggleClass('rotated');
        }

        function remove_layer() {
            var s = 0;
            for (s = selected_shapes.length - 1; s >= 0; s--) {
                if (selected_shapes[s] == true && shapes[s] != selection_box) {
                    for (var a = arrows.length - 1; a >= 0; a--) {
                        result = arrows[a].shapes_are_linked([shapes[s]]);
                        if (result[0] == true || result[1] == true) {
                            arrows.splice(a, 1);
                        }
                    }
                    shapes.splice(s, 1);
                    selected_shapes.splice(s, 1);
                }
            }
        }

        function add_layer() {
            for (s = 0; s < selected_shapes.length; s++) {
                selected_shapes[s] = false;
            }
            is_mouse_down = true;
            var layer_type = $("#layerType").val();
            var layer_name = $("#layerName").val();
            if (layer_name == "") {
                layer_name = get_short_name(layer_type);
                $("#layerName").val(layer_name);
            }

            // add latex name
            var layer_mathjax_element_idx = "";
            var latexName = $("#latexName").is(":checked");
            if (latexName) {
                $("#mathjax-elements").append('\\[ ' + layer_name + ' \\]');
                MathJax.Hub.Queue(["Typeset",MathJax.Hub,"mathjax-elements"]);
                mathjax_element_idx += 1;
                layer_mathjax_element_idx = mathjax_element_idx;
            }

            var shape;
            if (layer_type == "DataPlaceholder") {
                shape = new Rectangle(xm - 40, ym - 20, 80, 40, 3, 10, 3, layer_name, fill_colors[current_color_idx], border_colors[current_color_idx], false, layer_mathjax_element_idx);
            } else if (layer_type == "Concatenate") {
                shape = new Triangle(xm - 20, ym - 20, 40, 40, 2, 3, fill_colors[current_color_idx], border_colors[current_color_idx]);
            } else if (layer_type == "ElementWise") {
                shape = new Circle(xm - 20, ym - 20, 20, 3, layer_name, fill_colors[current_color_idx], border_colors[current_color_idx], layer_mathjax_element_idx);
            } else {
                shape = new Rectangle(xm - 40, ym - 20, 80, 40, 10, 0, 3, layer_name, fill_colors[current_color_idx], border_colors[current_color_idx], false, layer_mathjax_element_idx);
            }

            shapes.push(shape);
            selected_shapes.push(true);
            primary_selected_shape = shapes.length - 1;
        }

        function add_or_remove_layer() {
            if ($("#addLayerIcon").hasClass('rotated')) {
                remove_layer();
            } else {
                add_layer();
            }
            toggle_add_or_remove_button();
        }

        var border_colors = [
            new Color(142, 68, 173, 1),
            new Color(52, 152, 219, 1),
            new Color(39, 174, 96, 1),
            new Color(241, 196, 15, 1),
            new Color(230, 126, 34, 1),
            new Color(231, 76, 60, 1)
        ];

        var fill_colors = [];
        for (var i = 0; i < border_colors.length; i++) {
            border_color = border_colors[i];
            var max_val = Math.max(Math.max(border_color.r, border_color.g), border_color.b);
            fill_color = new Color(border_color.r + 0.5 * max_val, border_color.g + 0.5 * max_val, border_color.b + 0.5 * max_val, 0);
            fill_colors.push(fill_color);
        }

        function change_color(colorIdx) {
            current_color_idx = colorIdx;
            r = border_colors[colorIdx].r;
            g = border_colors[colorIdx].g;
            b = border_colors[colorIdx].b;
            for (var i = 0; i < 6; i++) {
                if (i == colorIdx) {
                    $('#color' + i.toString()).html('<i class="glyphicon glyphicon-ok" style="margin-top: 3px;margin-left:50%;left:-8px;color:rgba(255,255,255,0.7)"></i>');
                } else {
                    $('#color' + i.toString()).html('');
                }
            }
            var max_val = Math.max(Math.max(r, g), b);

            for (var s = 0; s < selected_shapes.length; s++) {
                if (shapes[s] != selection_box && selected_shapes[s] == true) {
                    var border_color = new Color(r, g, b, 1);
                    var fill_color = new Color(r + 0.5 * max_val, g + 0.5 * max_val, b + 0.5 * max_val, 0);

                    shapes[s].change_fill_color(fill_color);
                    shapes[s].change_border_color(border_color);
                    for (var a = 0; a < arrows.length; a++) {
                        arrows[a].linked_shape_color_change(shapes[s], arrows);
                    }
                }
            }

            save_state();
            draw();
        }

        function run() {
            // Fix the canvas width and height
            canvas = document.getElementById('cnv');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            // Objects style
            ctx = canvas.getContext('2d');

            degree = Math.PI / 180;

            function find_selected_shapes(selection_box, shapes) {
                var selected_shapes = [];
                for (var i = 0; i < shapes.length; i++) {
                    var left_check = shapes[i].x > selection_box.x;
                    var top_check = shapes[i].y > selection_box.y;
                    var right_check = shapes[i].x + shapes[i].width < selection_box.x + selection_box.width;
                    var bottom_check = shapes[i].y + shapes[i].height < selection_box.y + selection_box.height;
                    if ((left_check == true && top_check == true && right_check == true && bottom_check == true) ||
                        (left_check == false && top_check == false && right_check == false && bottom_check == false) ||
                        (left_check == true && top_check == false && right_check == true && bottom_check == false) ||
                        (left_check == false && top_check == true && right_check == false && bottom_check == true)) {
                        selected_shapes.push(true);
                    } else {
                        selected_shapes.push(false);
                    }
                }
                return selected_shapes;
            }

//            var rect1 = new Rectangle(100, 50, 80, 40, 2, 10, 3, "angle", fill_colors[0], border_colors[0]);
//            var rect2 = new Rectangle(200, 50, 80, 40, 10, 0, 3, "input", fill_colors[1], border_colors[1]);
//            var tri1 = new Triangle(300, 50, 40, 40, 2, 3, fill_colors[2], border_colors[2]);
//            var rect3 = new Rectangle(400, 50, 80, 40, 2, 10, 3, "flow", fill_colors[3], border_colors[3]);
//            var circ1 = new Circle(500, 50, 20, 3, "+", fill_colors[4], border_colors[4]);

            selected_shapes = shapes = [];
            draw_all_shapes(ctx);

            button = 0;
            is_mouse_down = false;
            pointer_is_on_shape_border = -1;
            need_draw = false;
            init_arrow = new Line([], 5, new Color(0, 0, 0, 1), 3);
            current_arrow = new Line([], 5, new Color(0, 0, 0, 1), 3);
            arrows = [];
            shapes_and_arrows = shapes.concat(arrows);

            shapes.push(selection_box);

            selected_shapes = find_selected_shapes(selection_box, shapes);

            save_state();

            function mouseDown(evt) {

                selection_box.hide();
                selection_box.width = 0;
                selection_box.height = 0;

                is_mouse_down = true;
                button = evt.button;

                shapes_and_arrows = shapes.concat(arrows);

                xm = evt.clientX - canvas.getBoundingClientRect().left;
                ym = evt.clientY - canvas.getBoundingClientRect().top;

                primary_selected_shape = -1;
                var s = 0;
                for (s = 0; s < shapes.length; s++) {
                    if (selected_shapes.length < shapes.length) {
                        selected_shapes[s] = false;
                    }
                    if (shapes[s].pointer_is_inside(xm, ym)) {
                        primary_selected_shape = s;
                        // if the currently selected shapes is not part of all the previously selected shapes, make it the only selected shape so that only it moves
                        // otherwise we want to move all the selected shapes together
                        if (selected_shapes[s] == false) {
                            for (var i = 0; i < shapes.length; i++) {
                                selected_shapes[i] = false;
                            }
                        }
                        selected_shapes[s] = true;
                    }
                }


                if (button == 0) {
                    // add point to current arrow
                    if (current_arrow.points >= 1) {
                        current_arrow.points++;
                    }
                    // check if the pointer is on the border of any shape
                    for (s = 0; s < shapes_and_arrows.length; s++) {
                        var borderDir = shapes_and_arrows[s].pointer_is_on_the_border(xm, ym, ctx);
                        if (borderDir) {
                            pointer_is_on_shape_border = s;
                            if (current_arrow.points == 0) {
                                // start a new line
                                current_arrow.startLine(new Vertex(xm, ym, 0), shapes_and_arrows[s].border_color, shapes_and_arrows[s], borderDir);
                            } else {
                                current_arrow.end_line(new Vertex(xm, ym, 0), shapes_and_arrows[s]);
                                arrows.push(current_arrow);
                                current_arrow = new Line([], 5, new Color(0, 0, 0, 1), 3);
                            }
                            break;
                        }
                    }

                    if (current_arrow.points == 0 && pointer_is_on_shape_border == -1) {
                        current_arrow = new Line([], 5, new Color(0, 0, 0, 1), 3);
                    }

                } else if (button == 2) {
                    if (primary_selected_shape > -1) {
                        var shape;
                        var curr = shapes[primary_selected_shape];
                        if (curr.type == "Rectangle") {
                            shape = new Rectangle(curr.x, curr.y + 70, curr.width, curr.height, curr.radius, curr.offset, curr.stroke, curr.text, curr.default_color, curr.border_color);
                        } else if (shapes[primary_selected_shape].type == "Triangle") {
                            shape = new Triangle(curr.x, curr.y + 70, curr.width, curr.height, curr.radius, curr.stroke, curr.default_color, curr.border_color);
                        } else if (shapes[primary_selected_shape].type == "Circle") {
                            shape = new Circle(curr.x, curr.y + 70, curr.radius, curr.stroke, curr.text, curr.default_color, curr.border_color);
                        }
                        shapes.push(shape);
                    }
                }
                var add_layer_icon = $("#addLayerIcon");
                if (primary_selected_shape == -1) {
                    selection_box.x = xm;
                    selection_box.y = ym;
                    selected_shapes = [];
                    if ($(add_layer_icon).hasClass('rotated')) {
                        toggle_add_or_remove_button();
                    }
                } else {
                    if (!$(add_layer_icon).hasClass('rotated')) {
                        toggle_add_or_remove_button();
                    }
                }
                shapes_and_arrows = shapes.concat(arrows);

                config(evt);
            }

            function snap_to_grid(step_size, counter, diff) {
                // uses the step size for shape movement to determine the new shape location
                var after = (counter + diff) / step_size;
                var before = counter / step_size;
                var change = 0;
                if (after < 0) {
                    change = Math.ceil(after) - Math.ceil(before);
                } else {
                    change = Math.floor(after) - Math.floor(before);
                }
                if (change != 0) {
                    diff = change * step_size;
                    counter = 0;
                } else {
                    counter += diff;
                    diff = 0;
                }
                return [counter, diff];
            }

            var count_x = 0;
            var count_y = 0;

            function mouseMove(evt) {
                $('body').css('cursor', 'default');
                if (typeof xm == 'undefined') xm = evt.clientX - canvas.getBoundingClientRect().left;
                if (typeof ym == 'undefined') ym = evt.clientY - canvas.getBoundingClientRect().top;
                var diffX = evt.clientX - canvas.getBoundingClientRect().left - xm;
                var diffY = evt.clientY - canvas.getBoundingClientRect().top - ym;
                xm = evt.clientX - canvas.getBoundingClientRect().left;
                ym = evt.clientY - canvas.getBoundingClientRect().top;
                //need_draw = false;

                // snap to grid
                var step_size = 1;
                var res = snap_to_grid(step_size, count_x, diffX);
                count_x = res[0];
                diffX = res[1];
                res = snap_to_grid(step_size, count_y, diffY);
                count_y = res[0];
                diffY = res[1];

                if (is_mouse_down && primary_selected_shape == -1 && current_arrow.points == 0) {
                    selection_box.width = xm - selection_box.x;
                    selection_box.height = ym - selection_box.y;
                    selection_box.show();
                    selected_shapes = find_selected_shapes(selection_box, shapes);
                    for (var s = 0; s < selected_shapes.length; s++) {
                        if (selected_shapes[s] == true && shapes[s] != selection_box) {
                            if (!$("#addLayerIcon").hasClass('rotated')) {
                                toggle_add_or_remove_button();
                            }
                            break;
                        }
                    }
                    need_draw = true;
                }

                pointer_is_on_shape_border = -1;
                for (s = 0; s < shapes.length; s++) {
                    if (shapes[s] == selection_box) continue;
                    //$('body').css('cursor', 'default');

                    if (shapes[s].pointer_is_inside(xm, ym)) {
                        $('body').css('cursor', 'pointer');
                    }
                    if (shapes[s].pointer_is_inside(xm, ym) || (selected_shapes.length > s && selected_shapes[s] == true)) {
                        shapes[s].highlight();
                        need_draw = true;
                    } else if ((shapes[s].color.to_string() != shapes[s].default_color.to_string())) {
                        shapes[s].darken();
                        need_draw = true;
                    }
                }
                for (s = 0; s < shapes_and_arrows.length; s++) {
                    if (shapes_and_arrows[s].pointer_is_on_the_border(xm, ym, ctx)) {
                        pointer_is_on_shape_border = s;
                        need_draw = true;
                    }
                }

                if (is_mouse_down) {
                    if (button == 0) {
                        // move shapes
                        if (primary_selected_shape > -1) {
                            var moved_shapes = [];
                            for (var i = 0; i < selected_shapes.length; i++) {
                                if (selected_shapes[i] == true) {
                                    shapes[i].translate(diffX, diffY);
                                    moved_shapes.push(shapes[i]);
                                }
                            }
                            for (var a = 0; a < arrows.length; a++) {
                                arrows[a].linked_shapes_moved(diffX, diffY, moved_shapes);
                            }

                            need_draw = true;
                        }
                    } else if (button == 2) {
                    }
                }

                if (current_arrow.vertices.length > 0) {
                    current_arrow.add_point(new Vertex(xm, ym, 0));
                }

                if (need_draw == true) {
                    draw();
                }
            }

            function mouseUp() {
                selection_box.hide();
                if ((Math.abs(selection_box.width) < 10 || Math.abs(selection_box.height) < 10) && primary_selected_shape == -1) {
                    selected_shapes = find_selected_shapes(selection_box, shapes);
                }
                is_mouse_down = false;
                if (xm >= 0 && ym >= 0) {
                    save_state();
                }
            }


            function config(evt) {
                xm = evt.clientX - canvas.getBoundingClientRect().left;
                ym = evt.clientY - canvas.getBoundingClientRect().top;
                primary_selected_shape = -1;
                for (var s = 0; s < shapes.length; s++) {
                    if (shapes[s].pointer_is_inside(xm, ym)) {
                        primary_selected_shape = s;
                    }
                }
                if (primary_selected_shape == -1) {
                    $("#layerName").val("");
                } else {
                    $("#layerName").val(shapes[primary_selected_shape].text);
                }
                setTimeout(function () {
                    $("#layerName").focus();
                }, 1);


                for (var i = 0; i < border_colors.length; i++) {
                    if (primary_selected_shape > -1 && border_colors[i].to_string() == shapes[primary_selected_shape].border_color.to_string()) {
                        current_color_idx = i;
                        $('#color' + i.toString()).html('<i class="glyphicon glyphicon-ok" style="margin-top: 3px;margin-left:50%;left:-8px;color:rgba(255,255,255,0.7)"></i>');
                    } else if (primary_selected_shape > -1) {
                        $('#color' + i.toString()).html('');
                    }
                }
                return true;
            }

            function show_message(msg) {
                var canvas_messages = $("#canvas_messages");
                $("#canvas_messages h1").text(msg);
                $(canvas_messages).stop();
                $(canvas_messages).fadeIn(30);
                $(canvas_messages).fadeOut(500);
            }

            function keyPress(evt) {
                evt = evt || window.event;
                var s = 0;
                if (evt.keyCode == 46) {
                    // Del ==> Remove selected layers
                    if ($("#addLayerIcon").hasClass('rotated')) {
                        remove_layer();
                        toggle_add_or_remove_button();
                        draw();
                    }
                } else if (evt.ctrlKey && evt.keyCode == 65) {
                    // Ctrl + A ==> Select all
                    for (s = 0; s < selected_shapes.length; s++) {
                        selected_shapes[s] = true;
                        shapes[s].highlight();
                    }
                    if (!$("#addLayerIcon").hasClass('rotated')) {
                        toggle_add_or_remove_button();
                    }
                    draw();
                } else if (evt.ctrlKey && evt.keyCode == 67) {
                    // Ctrl + C ==> Copy
                    show_message("Copied to clipboard");
                    clipboard = [];
                    for (s = 0; s < selected_shapes.length; s++) {
                        if (selected_shapes[s] && shapes[s] != selection_box) {
                            // I clone each object so that it will be detached from the original object
                            var copiedObject = shapes[s].clone();
                            clipboard.push(copiedObject);
                        }
                    }
                    $("#layerName").blur();
                } else if (evt.ctrlKey && evt.keyCode == 86) {
                    // Ctrl + V ==> Paste
                    for (s = 0; s < clipboard.length; s++) {
                        // I clone again each object from the clipboard so that multiple pastes will be possible
                        var copiedObject = clipboard[s].clone();
                        copiedObject.translate(50 + 10*Math.random(),50 + 20*Math.random());
                        copiedObject.highlight();
                        shapes.push(copiedObject);
                        selected_shapes.push(true);
                    }
                    save_state();
                    draw();
                } else if (evt.ctrlKey && evt.keyCode == 90 && !evt.shiftKey) {
                    // Ctrl + Z ==> undo
                    if (undo()) {
                        show_message("Undo changes");
                        highlight_selected_shapes();
                        draw();
                    }
                } else if ((evt.ctrlKey && evt.keyCode == 89) || (evt.ctrlKey && evt.shiftKey && evt.keyCode == 90)) {
                    // Ctrl + Y ==> redo
                    if (redo()) {
                        show_message("Redo changes");
                        highlight_selected_shapes();
                        draw();
                    }
                }


            }

            canvas.addEventListener('mousedown', mouseDown);
            document.addEventListener('mousemove', mouseMove);
            document.addEventListener('mouseup', mouseUp);
            document.addEventListener('keydown', keyPress);
        }
    </script>
</head>
<body onload="run()" style="overflow: hidden;" oncontextmenu="return false">
<!-- Github Form Me Ribbon -->
<a href="https://github.com/itaicaspi/Neuralizer">
    <img style="z-index: 10; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png">
</a>
<!--------------------------->
<div class="col-lg-2 divContainer side-bar">
    <div>
        <div class="appName">
            <h1>neuralizer</h1>
            <b style="font-size: 17px;text-align: center;">visual neural network designer</b>
        </div>
        <br>
        <div class="form-group">
            <label for="layerName" style="color:white">Name</label>
            <!-- Latex support -->
            <!--
            <div class="material-switch pull-right">
                <span style="padding-right: 5px;"><img src="images/latex.png" height="17px"></span>
                <input id="latexName" name="latexName" type="checkbox" />
                <label for="latexName" class="label-success"></label>
            </div>
            -->
            <input type="text" id="layerName" class="form-control" placeholder="Layer name" onkeyup="update_shape()">
        </div>
        <div class="form-group">
            <label for="layerType" style="color:white">Type</label>
            <select id="layerType" class="form-control selectpicker" onchange="toggle_params(this)">
                <optgroup label="Data">
                    <option value="DataPlaceholder">Data Placeholder</option>
                </optgroup>
                <optgroup label="Feedforward">
                    <option value="Convolution">Convolution</option>
                    <option value="Pooling">Pooling</option>
                    <option value="InnerProduct">Inner Product</option>
                    <option value="Deconvolution">Deconvolution</option>
                    <option value="Activation">Activation</option>
                    <option value="Regularization">Regularization</option>
                    <option value="Concatenate">Concatenate</option>
                    <option value="ElementWise">Element-Wise</option>
                    <option value="SpecialBlock">Special Block</option>
                </optgroup>
                <optgroup label="Normalization">
                    <option value="Batch Normalization">Batch Normalization</option>
                    <option value="LRN">LRN</option>
                </optgroup>
                <optgroup label="Recurrent">
                    <option value="RNN">RNN</option>
                    <option value="GRU">GRU</option>
                    <option value="LSTM">LSTM</option>
                </optgroup>
                <optgroup label="Classifiers / Loss Functions">
                    <option value="Softmax">Softmax</option>
                    <option value="L2 Loss">L2 Loss</option>
                    <option value="LSTM">LSTM</option>
                </optgroup>
            </select>
        </div>
        <hr class="separator">


        <!-- Data -->
        <div class="form-group" style="display: none;" id="dataParams">
            <label for="kernelSize" style="color:white; margin-bottom: 20px">Data Properties</label>
            <div class="row">
                <div class="col-lg-3">
                    <label for="dataWidth" style="color:white">Width</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="dataWidth" type="number" min="1" max="10000" value="1" style="width:70%;">
                </div>
                <div class="col-lg-3">
                    <label for="dataHeight" style="color:white">Height</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="dataHeight" type="number" min="1" max="10000" value="1" style="width:70%;">
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col-lg-3">
                    <label for="dataDepth" style="color:white">Depth</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="dataDepth" type="number" min="1" max="10000" value="1" style="width:70%;">
                </div>
            </div>
        </div>

        <!-- Convolution -->
        <div class="form-group" style="display: none;" id="convolutionParams">
            <label for="kernelSize" style="color:white; margin-bottom: 20px">Kernel Properties</label>
            <div class="row">
                <div class="col-lg-3">
                    <label for="kernelWidth" style="color:white">Width</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="kernelWidth" type="number" min="1" max="100" value="1" style="width:70%;">
                </div>
                <div class="col-lg-3">
                    <label for="kernelHeight" style="color:white">Height</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="kernelHeight" type="number" min="1" max="100" value="1" style="width:70%;">
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col-lg-3">
                    <label for="kernelStride" style="color:white">Stride</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="kernelStride" type="number" min="1" max="100" value="1" style="width:70%;">
                </div>
                <div class="col-lg-3">
                    <label for="kernelDilation" style="color:white">Dilation</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="kernelDilation" type="number" min="1" max="100" value="1" style="width:70%;">
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col-lg-6">
                    <label for="numOfms" style="color:white">Number of OFMs</label>
                </div>
                <div class="col-lg-6" style="text-align: right; padding-right: 22px">
                    <input id="numOfms" type="number" min="1" max="100000" value="1" style="width:70%;">
                </div>
            </div>
        </div>


        <!-- InnerProduct -->
        <div class="form-group" style="display: none;" id="innerProductParams">
            <div class="row">
                <div class="col-lg-6">
                    <label for="numOutputs" style="color:white">Output Size</label>
                </div>
                <div class="col-lg-6" style="padding:0; ">
                    <input id="numOutputs" type="number" min="1" max="10000" value="1" style="width:70%;">
                </div>
            </div>
        </div>


        <!-- Pooling -->
        <div class="form-group " style="display: none;" id="poolingParams">
            <label for="poolingType" style="color:white">Pooling Type</label>
            <select id="poolingType" class="form-control selectpicker">
                <option value="Max">Max</option>
                <option value="Average">Average</option>
                <option value="Stochastic">Stochastic</option>
            </select>
            <br><br>
            <label for="windowSize" style="color:white; margin-bottom: 20px">Window Properties</label>
            <div class="row">
                <div class="col-lg-3">
                    <label for="windowWidth" style="color:white">Width</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="windowWidth" type="number" min="1" max="100" value="1" style="width:70%;">
                </div>
                <div class="col-lg-3">
                    <label for="windowHeight" style="color:white">Height</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="windowHeight" type="number" min="1" max="100" value="1" style="width:70%;">
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col-lg-3">
                    <label for="windowStride" style="color:white">Stride</label>
                </div>
                <div class="col-lg-3" style="padding:0">
                    <input id="windowStride" type="number" min="1" max="100" value="1" style="width:70%;">
                </div>
            </div>
        </div>


        <!-- Activation -->
        <div class="form-group" style="display: none;" id="activationParams">
            <label for="activationType" style="color:white">Activation Type</label>
            <select id="activationType" class="form-control selectpicker">
                <option value="ReLU">ReLU</option>
                <option value="LeakyReLU">Leaky ReLU</option>
                <option value="pReLU">Parametrized ReLU</option>
                <option value="Sigmoid">Sigmoid</option>
                <option value="HardSigmoid">Hard Sigmoid</option>
                <option value="TanH">TanH</option>
                <option value="ELU">ELU</option>
            </select>
        </div>


        <!-- Regularization -->
        <div class="form-group" style="display: none;" id="regularizationParams">
            <label for="regularizationType" style="color:white">Regularization Type</label>
            <select id="regularizationType" class="form-control selectpicker">
                <option value="Dropout">Dropout</option>
                <option value="Maxout">Maxout</option>
                <option value="Zoneout">Zoneout</option>
            </select>
        </div>


        <!-- Element-Wise -->
        <div class="form-group" style="display: none;" id="elementWiseParams">
            <label for="elementWiseOperator" style="color:white">Element-wise Operator</label>
            <select id="elementWiseOperator" class="form-control selectpicker">
                <option value="Add">Add</option>
                <option value="Multiply">Multiply</option>
            </select>
        </div>

        <!-- Special Block -->
        <div class="form-group" style="display: none;" id="specialBlockParams">
            <label for="specialBlockType" style="color:white">Block Type</label>
            <select id="specialBlockType" class="form-control selectpicker">
                <option value="Inception">Inception</option>
                <option value="ResidualBlock">Residual Block</option>
                <option value="DenseEncoder">Dense Encoder</option>
                <option value="DenseDecoder">Dense Decoder</option>
                <option value="ConvEncoder">Convolutional Encoder</option>
                <option value="ConvDecoder">Convolutional Decoder</option>
            </select>
        </div>

        <div class="form-group">
            <label for="layerColor" style="color:white">Color</label>
            <div style="width:100%;cursor:pointer;" id="layerColor">
                <div class="layer-color" id="color0" onclick="change_color(0)"
                     style="background-color: rgb(142, 68, 173); border-top-left-radius: 3px;border-bottom-left-radius: 3px; ">
                    <i class="glyphicon glyphicon-ok"
                       style="margin-top: 3px;margin-left:50%;left:-8px;color:rgba(255,255,255,0.7)"></i>
                </div>
                <div class="layer-color" id="color1" onclick="change_color(1)"
                     style="background-color: rgb(52, 152, 219); ">
                </div>
                <div class="layer-color" id="color2" onclick="change_color(2)"
                     style="background-color: rgb(39, 174, 96); ">
                </div>
                <div class="layer-color" id="color3" onclick="change_color(3)"
                     style="background-color: rgb(241, 196, 15);">
                </div>
                <div class="layer-color" id="color4" onclick="change_color(4)"
                     style="background-color: rgb(230, 126, 34);">

                </div>
                <div class="layer-color" id="color5" onclick="change_color(5)"
                     style="background-color: rgb(231, 76, 60);border-top-right-radius: 3px;border-bottom-right-radius: 3px; border-style: none solid solid none;">
                </div>
            </div>
        </div>
        <br>
        <div class="form-group">
            <span style="padding-right: 5px; color:white"><b>Full Details</b></span>
            <div class="material-switch pull-right">
                <input id="fullDetails" name="latexName" type="checkbox" />
                <label for="fullDetails" class="label-success"></label>
            </div>
        </div>
        <div class="form-group" style="text-align:center;">
            <button type="button" id="addLayer" class="btn btn-default btn-circle btn-lg"
                    onclick="add_or_remove_layer()" style="outline:none;"><i data-toggle="tooltip" data-placement="top"
                                                                             title="Add" id="addLayerIcon"
                                                                             class="glyphicon glyphicon-plus"></i>
            </button>
        </div>
        <hr class="separator">
        <div class="form-group">
            <label for="framework" style="color:white">Framework</label>
            <select id="framework" class="form-control selectpicker">
                <option data-content="<img src='images/icon-tensorflow.png' style='margin-right:10px'>TensorFlow"
                        value="TensorFlow">TensorFlow
                </option>
                <option data-content="<img src='images/icon-caffe.png' style='margin-right:10px'> Caffe" value="Caffe">
                    Caffe
                </option>
                <option data-content="<img src='images/icon-theano.png' style='margin-right:10px'> Theano"
                        value="Theano">Theano
                </option>
                <option data-content="<img src='images/icon-torch.png' style='margin-right:10px'> Torch" value="Torch">
                    Torch
                </option>
                <option data-content="<img src='images/icon-keras.png' style='margin-right:10px'> Keras" value="Keras">
                    Keras
                </option>
                <option data-content="<img src='images/icon-pytorch.png' style='margin-right:10px'> PyTorch"
                        value="Keras">PyTorch
                </option>
                <!--
                    <option data-content="<span style='width: 80px; display: inline-block'><img src='images/icon-tensorflow.png'></span>TensorFlow" value="TensorFlow">TensorFlow</option>
                    <option data-content="<span style='width: 80px; display: inline-block'><img src='images/icon-caffe.png'></span>Caffe" value="Caffe">Caffe</option>
                    <option data-content="<span style='width: 80px; display: inline-block'><img src='images/icon-theano.png'></span>Theano" value="Theano">Theano</option>
                    <option data-content="<span style='width: 80px; display: inline-block'><img src='images/icon-torch.png'></span>Torch" value="Torch">Torch</option>
                    <option data-content="<span style='width: 80px; display: inline-block'><img src='images/icon-keras.png'></span>Keras" value="Keras">Keras</option>
                    <option data-content="<span style='width: 80px; display: inline-block'><img src='images/icon-pytorch.png'></span>PyTorch" value="Keras">PyTorch</option>
                -->
            </select>
        </div>
        <div class="form-group">
            <button type="button" id="saveTopology" class="form-control" onclick="save_current_state_to_file()">Save Topology</button>
        </div>
    </div>
</div>
<div class="col-lg-10" style="height:100%">
    <div id="canvas_messages" style="position: absolute; left: 0; top:0; width:100%; height:100%; display: none;">
        <div style="position: absolute; top: 50%; left:50%; margin-left: -320px; margin-top: -80px; color: white">
            <h1>Copied to clipboard</h1>
        </div>
    </div>
    <canvas id="cnv" width="100%" height="100%"></canvas>
    <div id="mathjax-elements">
        \[ {} \]
    </div>
</div>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-select.js"></script>
<script>
    $(document).ready(function () {
        // Initiate with custom caret icon
        $('select.selectpicker').selectpicker();
        // Initiate tooltip
        $('[data-toggle="tooltip"]').tooltip();

        toggle_params();
    });
</script>
</body>
</html>